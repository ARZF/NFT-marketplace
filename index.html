<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Python NFT Marketplace</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/ethers@6.11.1/dist/ethers.min.js"></script>
</head>

<body class="bg-slate-950 text-white min-h-screen">
    <header class="bg-slate-900 border-b border-slate-800">
        <div class="max-w-5xl mx-auto px-6 py-6 flex flex-wrap gap-4 items-center justify-between">
            <div>
                <p class="text-sm text-slate-400">FastAPI + Web3 Demo</p>
                <h1 class="text-2xl font-semibold text-white">Python NFT Marketplace</h1>
            </div>
            <button id="walletButton"
                class="px-4 py-2 rounded-md bg-slate-100 text-slate-900 font-semibold hover:bg-white transition">
                Connect Wallet
            </button>
        </div>
    </header>

    <main class="max-w-5xl mx-auto px-6 py-12">
        <section>
            <div class="flex items-end justify-between gap-4 flex-wrap mb-8">
                <div>
                    <p class="text-sm uppercase text-slate-400 tracking-wide">
                        Marketplace Inventory
                    </p>
                    <h2 class="text-3xl font-semibold text-white">
                        Active Listings
                    </h2>
                </div>
                <p class="text-slate-400 text-sm">
                    Data source: <code>/api/listings</code>
                </p>
            </div>
            <div id="listingsGrid" class="grid gap-6 sm:grid-cols-2 lg:grid-cols-3">
                <!-- Listing cards populated by JS -->
            </div>
            <div id="emptyState" class="hidden text-center text-slate-500 mt-16">
                No active listings found.
            </div>
        </section>
    </main>

    <template id="listingCardTemplate">
        <article class="bg-slate-900 border border-slate-800 rounded-2xl p-5 flex flex-col gap-4">
            <div class="h-48 rounded-xl bg-cover bg-center bg-slate-800" data-field="image"></div>
            <div>
                <h3 class="text-xl font-semibold text-white" data-field="title"></h3>
                <p class="text-slate-400 text-sm break-words" data-field="address"></p>
            </div>
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-xs uppercase tracking-wide text-slate-400">
                        Price
                    </p>
                    <p class="text-2xl font-bold text-emerald-400" data-field="price"></p>
                </div>
                <button
                    class="buy-btn px-4 py-2 rounded-lg font-semibold text-slate-900 bg-emerald-400 hover:bg-emerald-300 transition disabled:opacity-50 disabled:cursor-not-allowed"
                    type="button">
                    Buy NFT
                </button>
            </div>
            <p class="text-xs text-slate-500" data-field="seller"></p>
        </article>
    </template>

    <script>
        const LOCAL_API_FALLBACK = "http://localhost:8000";
        const params = new URLSearchParams(window.location.search);
        const manualApiOverride = params.get("api");
        const isHostedOnVercel = window.location.hostname.endsWith(".vercel.app");
        const API_BASE = (manualApiOverride ?? (isHostedOnVercel ? window.location.origin : LOCAL_API_FALLBACK)).replace(
            /\/$/,
            ""
        );
        const API_LISTINGS_URL = `${API_BASE}/api/listings`;
        const MARKETPLACE_ADDRESS = "0x0000000000000000000000000000000000dEaD00";
        const MARKETPLACE_ABI = [
            "function buyItem(address nftAddress, uint256 tokenId) payable",
        ];

        const listingsGrid = document.getElementById("listingsGrid");
        const emptyState = document.getElementById("emptyState");
        const walletButton = document.getElementById("walletButton");

        let provider = null;
        let signer = null;
        let userAddress = null;

        walletButton.addEventListener("click", () => connectWallet());

        async function connectWallet() {
            if (!window.ethereum) {
                alert("MetaMask (or another EIP-1193 wallet) is required.");
                return;
            }
            try {
                provider = new ethers.BrowserProvider(window.ethereum);
                await provider.send("eth_requestAccounts", []);
                signer = await provider.getSigner();
                userAddress = await signer.getAddress();
                walletButton.textContent = shortenAddress(userAddress);
                walletButton.classList.remove("bg-slate-100", "text-slate-900");
                walletButton.classList.add("bg-emerald-400", "text-slate-900");
            } catch (error) {
                console.error("Wallet connection failed", error);
                alert(`Unable to connect wallet: ${error.message}`);
            }
        }

        async function fetchListings() {
            try {
                const response = await fetch(API_LISTINGS_URL);
                if (!response.ok) {
                    throw new Error(`API returned ${response.status}`);
                }
                const listings = await response.json();
                renderListings(listings);
            } catch (error) {
                console.error("Failed to fetch listings", error);
                emptyState.textContent = "Unable to load listings. Check backend.";
                emptyState.classList.remove("hidden");
            }
        }

        function renderListings(listings) {
            listingsGrid.innerHTML = "";
            if (!listings.length) {
                emptyState.classList.remove("hidden");
                return;
            }
            emptyState.classList.add("hidden");
            listings.forEach((listing) => {
                const template = document
                    .getElementById("listingCardTemplate")
                    .content.cloneNode(true);

                const tokenName = `Token #${listing.token_id}`;
                const mockImage = `https://picsum.photos/seed/${listing.token_id}/400/300`;

                template.querySelector('[data-field="title"]').textContent = tokenName;
                template.querySelector('[data-field="address"]').textContent = `NFT: ${shortenAddress(listing.nft_address)}`;
                template.querySelector('[data-field="price"]').textContent = `${listing.price_eth} ETH`;
                template.querySelector('[data-field="seller"]').textContent = `Seller: ${shortenAddress(
                    listing.seller_address
                )}`;
                template.querySelector('[data-field="image"]').style.backgroundImage = `url(${mockImage})`;

                const buyButton = template.querySelector(".buy-btn");
                buyButton.addEventListener("click", () => handleBuy(listing, buyButton));

                listingsGrid.appendChild(template);
            });
        }

        async function handleBuy(listing, button) {
            try {
                if (!signer) {
                    await connectWallet();
                }
                if (!signer) {
                    return;
                }
                const contract = new ethers.Contract(MARKETPLACE_ADDRESS, MARKETPLACE_ABI, signer);
                button.disabled = true;
                button.textContent = "Confirm in wallet...";
                const tx = await contract.buyItem(listing.nft_address, listing.token_id, {
                    value: listing.price_wei,
                });
                button.textContent = "Waiting for block...";
                await tx.wait();
                button.textContent = "SOLD";
                button.classList.remove("bg-emerald-400", "hover:bg-emerald-300");
                button.classList.add("bg-slate-700", "text-slate-400");
                alert(`Success! Tx hash: ${tx.hash}`);
            } catch (error) {
                console.error("Transaction failed", error);
                alert(error?.data?.message ?? error.message ?? "Transaction rejected");
                button.disabled = false;
                button.textContent = "Buy NFT";
            }
        }

        function shortenAddress(address = "") {
            if (!address || address.length < 10) return address || "N/A";
            return `${address.slice(0, 6)}...${address.slice(-4)}`;
        }

        fetchListings();
    </script>
</body>

</html>